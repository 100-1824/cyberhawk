<?php

/**
 * MalwareService Class
 *
 * Purpose: Handles malware sample uploads, scanning, analysis, and reporting
 * Replaces: upload_malware_sample(), start_malware_scan(), get_malware_scan_progress(),
 *           get_malware_report(), get_all_malware_reports(), get_malware_stats(),
 *           get_scan_queue(), delete_malware_sample(), export_malware_report()
 */
class MalwareService {

    private $db;

    /**
     * Constructor
     */
    public function __construct() {
        $this->db = new DatabaseHelper();
    }

    /**
     * Upload malware sample
     *
     * @return void JSON response
     */
    public function uploadSample() {
        if (session_status() === PHP_SESSION_NONE) session_start();
        header('Content-Type: application/json');

        if (!isset($_FILES['file'])) {
            echo json_encode([
                'success' => false,
                'message' => 'No file uploaded'
            ]);
            return;
        }

        $userId = $_SESSION['user_id'] ?? null;
        $projectDir = rtrim(DIR, '/\\');
        $uploadsDir = $projectDir . '/assets/data/malware_uploads';

        if (!is_dir($uploadsDir)) {
            mkdir($uploadsDir, 0755, true);
        }

        // Load notifications helper
        require_once DIR . "app/helpers/notifications.php";

        try {
            $file = $_FILES['file'];
            $filename = basename($file['name']);
            $fileId = md5($filename . time());
            $uploadPath = $uploadsDir . '/' . $fileId . '_' . $filename;

            if (move_uploaded_file($file['tmp_name'], $uploadPath)) {
                $queueFile = $projectDir . '/assets/data/scan_queue.json';
                $queueData = file_exists($queueFile) ? json_decode(file_get_contents($queueFile), true) : [];
                $queue = is_array($queueData) ? $queueData : [];

                $queue[] = [
                    'id' => $fileId,
                    'filename' => $filename,
                    'filepath' => $uploadPath,
                    'upload_time' => date('Y-m-d H:i:s'),
                    'status' => 'pending',
                    'size' => $file['size']
                ];

                file_put_contents($queueFile, json_encode($queue, JSON_PRETTY_PRINT));

                // Add notification
                if ($userId) {
                    add_notification(
                        $userId,
                        'success',
                        'Malware Sample Uploaded',
                        "File '{$filename}' uploaded successfully and added to scan queue",
                        [
                            'file_id' => $fileId,
                            'filename' => $filename,
                            'size' => $file['size'],
                            'action' => 'upload_malware'
                        ]
                    );
                }

                echo json_encode([
                    'success' => true,
                    'message' => 'File uploaded successfully',
                    'file_id' => $fileId,
                    'filename' => $filename
                ]);
            } else {
                echo json_encode([
                    'success' => false,
                    'message' => 'Failed to upload file'
                ]);
            }

        } catch (Exception $e) {
            echo json_encode([
                'success' => false,
                'message' => 'Error: ' . $e->getMessage()
            ]);
        }
    }

    /**
     * Start malware scan
     *
     * @return void JSON response
     */
    public function startScan() {
        if (session_status() === PHP_SESSION_NONE) session_start();
        header('Content-Type: application/json');

        $userId = $_SESSION['user_id'] ?? null;
        $input = $_POST;
        if (empty($input)) {
            $rawInput = file_get_contents('php://input');
            parse_str($rawInput, $input);
        }

        $fileId = $input['file_id'] ?? $_POST['file_id'] ?? null;

        if (!$fileId) {
            echo json_encode([
                'success' => false,
                'message' => 'File ID required'
            ]);
            return;
        }

        $projectDir = rtrim(DIR, '/\\');
        $pythonPath = $projectDir . '/fyp/Scripts/python.exe';
        $scannerScript = $projectDir . '/python/malware/malware_scanner.py';

        if (!file_exists($scannerScript)) {
            echo json_encode([
                'success' => false,
                'message' => 'Scanner script not found'
            ]);
            return;
        }

        // Load notifications helper
        require_once DIR . "app/helpers/notifications.php";

        try {
            // Get filename from queue
            $queueFile = $projectDir . '/assets/data/scan_queue.json';
            $filename = 'Unknown file';
            if (file_exists($queueFile)) {
                $queueData = json_decode(file_get_contents($queueFile), true);
                if (is_array($queueData)) {
                    foreach ($queueData as $item) {
                        if ($item['id'] === $fileId) {
                            $filename = $item['filename'];
                            break;
                        }
                    }
                }
            }

            $progressFile = $projectDir . '/assets/data/malware_scan_progress.json';
            file_put_contents($progressFile, json_encode([
                'file_id' => $fileId,
                'progress' => 0,
                'status' => 'Initializing scan...',
                'stage' => 'init'
            ], JSON_PRETTY_PRINT));

            $cmd = "powershell -Command \"Start-Process -FilePath '$pythonPath' -ArgumentList '$scannerScript --file-id $fileId' -WindowStyle Hidden -PassThru | Select-Object -ExpandProperty Id\"";
            $pid = trim(shell_exec($cmd));

            if (is_numeric($pid) && $pid > 0) {
                // Add notification
                if ($userId) {
                    add_notification(
                        $userId,
                        'info',
                        'Malware Scan Started',
                        "Analysis started for '{$filename}'",
                        [
                            'file_id' => $fileId,
                            'filename' => $filename,
                            'pid' => $pid,
                            'action' => 'start_malware_scan'
                        ]
                    );
                }

                echo json_encode([
                    'success' => true,
                    'message' => 'Malware scan started',
                    'pid' => $pid,
                    'file_id' => $fileId
                ]);
            } else {
                echo json_encode([
                    'success' => false,
                    'message' => 'Failed to start scan'
                ]);
            }

        } catch (Exception $e) {
            echo json_encode([
                'success' => false,
                'message' => 'Error: ' . $e->getMessage()
            ]);
        }
    }

    /**
     * Get malware scan progress
     *
     * @return void JSON response
     */
    public function getScanProgress() {
        header('Content-Type: application/json');

        $projectDir = rtrim(DIR, '/\\');
        $progressFile = $projectDir . '/assets/data/malware_scan_progress.json';

        if (file_exists($progressFile)) {
            $data = json_decode(file_get_contents($progressFile), true);

            if (!is_array($data)) {
                $data = [
                    'progress' => 0,
                    'status' => 'Idle',
                    'stage' => 'none'
                ];
            }

            echo json_encode($data);
        } else {
            echo json_encode([
                'progress' => 0,
                'status' => 'Idle',
                'stage' => 'none'
            ]);
        }
    }

    /**
     * Get malware report for a specific file
     *
     * @return void JSON response
     */
    public function getReport() {
        header('Content-Type: application/json');

        $fileId = $_GET['file_id'] ?? null;

        if (!$fileId) {
            echo json_encode([
                'success' => false,
                'message' => 'File ID required'
            ]);
            return;
        }

        $projectDir = rtrim(DIR, '/\\');
        $reportsFile = $projectDir . '/assets/data/malware_reports.json';

        if (file_exists($reportsFile)) {
            $reports = json_decode(file_get_contents($reportsFile), true);

            if (!is_array($reports)) {
                echo json_encode([
                    'success' => false,
                    'message' => 'Invalid reports data'
                ]);
                return;
            }

            foreach ($reports as $report) {
                if ($report['file_id'] === $fileId) {
                    echo json_encode([
                        'success' => true,
                        'report' => $report
                    ]);
                    return;
                }
            }
        }

        echo json_encode([
            'success' => false,
            'message' => 'Report not found'
        ]);
    }

    /**
     * Get all malware reports
     *
     * @return void JSON response
     */
    public function getAllReports() {
        header('Content-Type: application/json');

        $projectDir = rtrim(DIR, '/\\');
        $reportsFile = $projectDir . '/assets/data/malware_reports.json';

        if (file_exists($reportsFile)) {
            $reports = json_decode(file_get_contents($reportsFile), true);
            echo json_encode(is_array($reports) ? $reports : []);
        } else {
            echo json_encode([]);
        }
    }

    /**
     * Get malware statistics
     *
     * @return void JSON response
     */
    public function getStats() {
        header('Content-Type: application/json');

        $projectDir = rtrim(DIR, '/\\');
        $statsFile = $projectDir . '/assets/data/malware_stats.json';

        if (file_exists($statsFile)) {
            $stats = json_decode(file_get_contents($statsFile), true);
            echo json_encode(is_array($stats) ? $stats : $this->getDefaultMalwareStats());
        } else {
            echo json_encode($this->getDefaultMalwareStats());
        }
    }

    /**
     * Get scan queue
     *
     * @return void JSON response
     */
    public function getScanQueue() {
        header('Content-Type: application/json');

        $projectDir = rtrim(DIR, '/\\');
        $queueFile = $projectDir . '/assets/data/scan_queue.json';

        if (file_exists($queueFile)) {
            $queue = json_decode(file_get_contents($queueFile), true);
            echo json_encode(is_array($queue) ? $queue : []);
        } else {
            echo json_encode([]);
        }
    }

    /**
     * Delete malware sample
     *
     * @return void JSON response
     */
    public function deleteSample() {
        header('Content-Type: application/json');

        $input = $_POST;
        if (empty($input)) {
            $rawInput = file_get_contents('php://input');
            parse_str($rawInput, $input);
        }

        $fileId = $input['file_id'] ?? $_POST['file_id'] ?? null;

        if (!$fileId) {
            echo json_encode([
                'success' => false,
                'message' => 'File ID required'
            ]);
            return;
        }

        $projectDir = rtrim(DIR, '/\\');
        $uploadsDir = $projectDir . '/assets/data/malware_uploads';

        try {
            $queueFile = $projectDir . '/assets/data/scan_queue.json';
            if (file_exists($queueFile)) {
                $queue = json_decode(file_get_contents($queueFile), true);

                if (!is_array($queue)) {
                    $queue = [];
                }

                $queue = array_filter($queue, function($item) use ($fileId) {
                    return isset($item['id']) && $item['id'] !== $fileId;
                });
                file_put_contents($queueFile, json_encode(array_values($queue), JSON_PRETTY_PRINT));
            }

            $reportsFile = $projectDir . '/assets/data/malware_reports.json';
            if (file_exists($reportsFile)) {
                $reports = json_decode(file_get_contents($reportsFile), true);

                if (!is_array($reports)) {
                    $reports = [];
                }

                $reports = array_filter($reports, function($item) use ($fileId) {
                    return isset($item['file_id']) && $item['file_id'] !== $fileId;
                });
                file_put_contents($reportsFile, json_encode(array_values($reports), JSON_PRETTY_PRINT));
            }

            if (is_dir($uploadsDir)) {
                $files = glob($uploadsDir . '/' . $fileId . '_*');
                foreach ($files as $file) {
                    @unlink($file);
                }
            }

            echo json_encode([
                'success' => true,
                'message' => 'Sample deleted successfully'
            ]);

        } catch (Exception $e) {
            echo json_encode([
                'success' => false,
                'message' => 'Error: ' . $e->getMessage()
            ]);
        }
    }

    /**
     * Export malware report
     *
     * @return void JSON response
     */
    public function exportReport() {
        header('Content-Type: application/json');

        $input = $_POST;
        if (empty($input)) {
            $rawInput = file_get_contents('php://input');
            parse_str($rawInput, $input);
        }

        $fileId = $input['file_id'] ?? $_POST['file_id'] ?? null;
        $format = $input['format'] ?? $_POST['format'] ?? 'json';

        if (!$fileId) {
            echo json_encode([
                'success' => false,
                'message' => 'File ID required'
            ]);
            return;
        }

        $projectDir = rtrim(DIR, '/\\');
        $reportsFile = $projectDir . '/assets/data/malware_reports.json';

        if (file_exists($reportsFile)) {
            $reports = json_decode(file_get_contents($reportsFile), true);

            if (!is_array($reports)) {
                echo json_encode([
                    'success' => false,
                    'message' => 'Invalid reports data'
                ]);
                return;
            }

            foreach ($reports as $report) {
                if ($report['file_id'] === $fileId) {
                    $exportDir = $projectDir . '/assets/data/exports';
                    if (!is_dir($exportDir)) {
                        mkdir($exportDir, 0755, true);
                    }

                    $filename = 'malware_report_' . $fileId . '.' . $format;
                    $exportPath = $exportDir . '/' . $filename;

                    if ($format === 'json') {
                        file_put_contents($exportPath, json_encode($report, JSON_PRETTY_PRINT));
                    }

                    echo json_encode([
                        'success' => true,
                        'message' => 'Report exported',
                        'download_url' => MDIR . 'assets/data/exports/' . $filename
                    ]);
                    return;
                }
            }
        }

        echo json_encode([
            'success' => false,
            'message' => 'Report not found'
        ]);
    }

    /**
     * Get default malware statistics
     *
     * @return array Default malware stats
     */
    private function getDefaultMalwareStats() {
        return [
            'total_scans' => 0,
            'malware_detected' => 0,
            'clean_files' => 0,
            'suspicious_files' => 0,
            'last_scan' => 'Never'
        ];
    }
}

?>
