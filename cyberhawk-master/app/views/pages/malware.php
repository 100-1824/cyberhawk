<?php
$httpMethod = $_SERVER['REQUEST_METHOD'];
$uri = $_SERVER['REQUEST_URI'];

if (false !== $pos = strpos($uri, '?')) {
    $uri = substr($uri, 0, $pos);
}

$basePath = MDIR;
if (strpos($uri, $basePath) === 0) {
    $uri = substr($uri, strlen($basePath));
    if ($uri === '') {
        $uri = '/';
    }
}
?>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CyberHawk - Malware Analysis</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
    html,
    body {
        max-width: 100%;
        overflow-x: hidden;
    }

    .card {
        width: 100%;
    }

    .my-card {
        border: 2px solid #6f42c1;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .gradient-text {
        background: linear-gradient(135deg, #6f42c1, #4a148c);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: transparent;
        font-weight: bold;
    }

    .upload-zone {
        border: 3px dashed #6f42c1;
        border-radius: 15px;
        padding: 60px 20px;
        text-align: center;
        background: linear-gradient(135deg, rgba(111, 66, 193, 0.05), rgba(74, 20, 140, 0.05));
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-zone:hover {
        border-color: #4a148c;
        background: linear-gradient(135deg, rgba(111, 66, 193, 0.1), rgba(74, 20, 140, 0.1));
        transform: translateY(-2px);
    }

    .upload-zone.dragover {
        border-color: #28a745;
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(25, 135, 84, 0.1));
    }

    .upload-icon {
        font-size: 4rem;
        color: #6f42c1;
        margin-bottom: 20px;
    }

    .file-input {
        display: none;
    }

    .scan-progress-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
    }

    .progress-ring {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: conic-gradient(#28a745 0%, #28a745 0%, transparent 0%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        position: relative;
    }

    .progress-ring::before {
        content: '';
        position: absolute;
        width: 90px;
        height: 90px;
        border-radius: 50%;
        background: white;
    }

    .progress-text {
        position: relative;
        z-index: 1;
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
    }

    .report-card {
        border-left: 5px solid #6f42c1;
        transition: all 0.3s ease;
    }

    .report-card:hover {
        box-shadow: 0 5px 15px rgba(111, 66, 193, 0.3);
        transform: translateX(5px);
    }

    .threat-badge {
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .threat-high {
        background-color: #dc3545;
        color: white;
    }

    .threat-medium {
        background-color: #fd7e14;
        color: white;
    }

    .threat-low {
        background-color: #ffc107;
        color: #333;
    }

    .threat-clean {
        background-color: #28a745;
        color: white;
    }

    .stats-card {
        text-align: center;
        padding: 20px;
    }

    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }

    .stats-label {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .analysis-detail {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #dee2e6;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-weight: 600;
        color: #495057;
    }

    .detail-value {
        color: #6c757d;
    }

    .hash-display {
        font-family: 'Courier New', monospace;
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 5px;
        word-break: break-all;
        font-size: 0.85rem;
    }

    /* FIXED STYLES FOR SCAN MODAL */
    .scan-stage {
        display: flex;
        align-items: center;
        margin: 15px 0;
        text-align: left;
    }

    .stage-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        flex-shrink: 0;
        font-size: 1.2rem;
        color: #6c757d;
        transition: all 0.3s ease;
    }

    .stage-icon.active {
        background-color: #6f42c1;
        color: white;
        animation: pulse 1.5s infinite;
    }

    .stage-icon.complete {
        background-color: #28a745;
        color: white;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(111, 66, 193, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(111, 66, 193, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(111, 66, 193, 0);
        }
    }

    .stage-content {
        flex: 1;
        min-width: 0;
    }

    .stage-content strong {
        display: block;
        color: #333;
        font-size: 0.95rem;
        margin-bottom: 3px;
    }

    .stage-content .text-muted {
        font-size: 0.85rem;
        line-height: 1.3;
    }

    .modal-backdrop.show {
        opacity: 0.7;
    }

    .scan-modal .modal-content {
        border-radius: 15px;
        border: none;
    }

    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #6f42c1;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .queue-item {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }

    .queue-item:hover {
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .queue-status {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-pending {
        background-color: #ffc107;
        color: #333;
    }

    .status-scanning {
        background-color: #0dcaf0;
        color: white;
    }

    .status-complete {
        background-color: #28a745;
        color: white;
    }

    .behavior-indicator {
        display: inline-block;
        padding: 5px 10px;
        margin: 3px;
        border-radius: 5px;
        font-size: 0.8rem;
        background-color: #e9ecef;
        color: #495057;
    }

    .behavior-suspicious {
        background-color: #fd7e14;
        color: white;
    }

    .behavior-malicious {
        background-color: #dc3545;
        color: white;
    }
    </style>
</head>

<body>
    <?php include 'app/views/common/header.php'; ?>

    <div class="d-flex" style="min-height: calc(100vh - 60px);">
        <?php include 'app/views/common/sidebar.php'; ?>

        <div class="main-content flex-grow-1 p-4">
            <div class="container-fluid">

                <!-- Page Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h2 class="gradient-text">
                            <i class="bi bi-bug-fill"></i> Advanced Malware Analysis
                        </h2>
                        <p class="text-muted">Multi-source malware detection with VirusTotal, MalwareBazaar & ThreatFox
                        </p>
                    </div>
                </div>


                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="card my-card">
                            <div class="card-body stats-card">
                                <i class="bi bi-file-earmark-check" style="font-size: 2rem; color: #6f42c1;"></i>
                                <div class="stats-number text-primary" id="totalScans">0</div>
                                <div class="stats-label">Total Scans</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card my-card">
                            <div class="card-body stats-card">
                                <i class="bi bi-shield-x" style="font-size: 2rem; color: #dc3545;"></i>
                                <div class="stats-number text-danger" id="malwareDetected">0</div>
                                <div class="stats-label">Malware Detected</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card my-card">
                            <div class="card-body stats-card">
                                <i class="bi bi-shield-check" style="font-size: 2rem; color: #28a745;"></i>
                                <div class="stats-number text-success" id="cleanFiles">0</div>
                                <div class="stats-label">Clean Files</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card my-card">
                            <div class="card-body stats-card">
                                <i class="bi bi-exclamation-triangle" style="font-size: 2rem; color: #ffc107;"></i>
                                <div class="stats-number text-warning" id="suspiciousFiles">0</div>
                                <div class="stats-label">Suspicious</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload and Queue Row -->
                <div class="row g-4 mb-4">
                    <!-- Upload Zone -->
                    <div class="col-md-6">
                        <div class="card my-card">
                            <div class="card-header">
                                <h5 class="card-title mb-0 gradient-text">
                                    <i class="bi bi-cloud-upload"></i> Upload Sample for Analysis
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="upload-zone" id="uploadZone" onclick="$('#fileInput').click()">
                                    <i class="bi bi-cloud-arrow-up upload-icon"></i>
                                    <h4>Drop files here or click to browse</h4>
                                    <p class="text-muted mb-0">Supported: EXE, DLL, PDF, DOC, ZIP (Max 50MB)</p>
                                </div>
                                <input type="file" id="fileInput" class="file-input"
                                    accept=".exe,.dll,.pdf,.doc,.docx,.zip,.rar">

                                <div class="mt-3" id="uploadProgress" style="display: none;">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span id="uploadFileName">Uploading...</span>
                                        <span id="uploadPercent">0%</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                            id="uploadProgressBar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Scan Queue -->
                    <div class="col-md-6">
                        <div class="card my-card" style="height: 100%;">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 gradient-text">
                                    <i class="bi bi-list-check"></i> Scan Queue
                                </h5>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshQueue()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                <div id="scanQueue">
                                    <div class="text-center text-muted py-4">
                                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                        <p>No files in queue</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Reports -->
                <div class="row g-4">
                    <div class="col-12">
                        <div class="card my-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0 gradient-text">
                                    <i class="bi bi-file-earmark-text"></i> Analysis Reports
                                </h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-success" onclick="exportAllReports()">
                                        <i class="bi bi-download"></i> Export All
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="reportsList">
                                    <div class="text-center text-muted py-4">
                                        <i class="bi bi-file-earmark-x" style="font-size: 3rem;"></i>
                                        <p>No analysis reports available</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- FIXED SCAN PROGRESS MODAL -->
    <div class="modal fade scan-modal" id="scanModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title gradient-text">
                        <i class="bi bi-shield-check"></i> Analyzing Sample
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="spinner mb-3"></div>
                        <h3 class="text-primary mb-0" id="scanPercentage">0%</h3>
                    </div>

                    <!-- PROPERLY STRUCTURED SCAN STAGES -->
                    <div class="scan-stage">
                        <div class="stage-icon" id="stage1">
                            <i class="bi bi-1-circle-fill"></i>
                        </div>
                        <div class="stage-content">
                            <strong>Static Analysis</strong>
                            <p class="text-muted mb-0">Examining file structure and signatures</p>
                        </div>
                    </div>

                    <div class="scan-stage">
                        <div class="stage-icon" id="stage2">
                            <i class="bi bi-2-circle-fill"></i>
                        </div>
                        <div class="stage-content">
                            <strong>Multi-Source Detection</strong>
                            <p class="text-muted mb-0">VirusTotal, MalwareBazaar & ThreatFox</p>
                        </div>
                    </div>

                    <div class="scan-stage">
                        <div class="stage-icon" id="stage3">
                            <i class="bi bi-3-circle-fill"></i>
                        </div>
                        <div class="stage-content">
                            <strong>Behavioral Analysis</strong>
                            <p class="text-muted mb-0">Analyzing malicious behaviors</p>
                        </div>
                    </div>

                    <div class="scan-stage">
                        <div class="stage-icon" id="stage4">
                            <i class="bi bi-4-circle-fill"></i>
                        </div>
                        <div class="stage-content">
                            <strong>Report Generation</strong>
                            <p class="text-muted mb-0">Compiling results</p>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <p class="text-muted mb-0" id="scanStatusText">Initializing scan...</p>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button class="btn btn-secondary" onclick="cancelScan()">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Detail Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title gradient-text" id="reportModalTitle">
                        <i class="bi bi-file-earmark-text"></i> Analysis Report
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="reportModalBody">
                    <!-- Dynamic content -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" onclick="exportCurrentReport()">
                        <i class="bi bi-download"></i> Export Report
                    </button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    let currentScanId = null;
    let scanCheckInterval = null;
    let currentReportId = null;

    // ==================== INITIALIZATION ====================

    $(document).ready(function() {
        console.log('[INIT] Initializing malware analysis page...');
        updateStatistics();
        loadReports();
        loadScanQueue();
        setupDragDrop();
    });

    // ==================== FILE UPLOAD ====================

    function setupDragDrop() {
        const uploadZone = $('#uploadZone')[0];

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });
    }

    $('#fileInput').on('change', function() {
        const file = this.files[0];
        if (file) {
            handleFileUpload(file);
        }
    });

    function handleFileUpload(file) {
        console.log('[UPLOAD] Starting upload:', file.name);

        // Validate file size (50MB max)
        if (file.size > 50 * 1024 * 1024) {
            showNotification('Error', 'File too large (max 50MB)', 'danger');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        $('#uploadProgress').show();
        $('#uploadFileName').text(file.name);

        $.ajax({
            url: "<?= MDIR ?>upload-malware-sample",
            method: "POST",
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener("progress", function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        $('#uploadProgressBar').css('width', percentComplete + '%');
                        $('#uploadPercent').text(Math.round(percentComplete) + '%');
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                console.log('[UPLOAD]', response);
                if (response.success) {
                    showNotification('Success', 'File uploaded successfully', 'success');
                    $('#uploadProgress').hide();
                    $('#fileInput').val('');
                    loadScanQueue();

                    // Auto-start scan
                    setTimeout(() => startScan(response.file_id), 1000);
                } else {
                    showNotification('Error', response.message, 'danger');
                    $('#uploadProgress').hide();
                }
            },
            error: function(xhr, status, error) {
                showNotification('Error', 'Upload failed: ' + error, 'danger');
                $('#uploadProgress').hide();
            }
        });
    }

    // ==================== SCANNING ====================

    function startScan(fileId) {
        console.log('[SCAN] Starting scan for:', fileId);
        currentScanId = fileId;

        showScanModal();

        $.ajax({
            url: "<?= MDIR ?>start-malware-scan",
            method: "POST",
            data: {
                file_id: fileId
            },
            dataType: "json",
            success: function(response) {
                console.log('[SCAN] Response:', response);
                if (response.success) {
                    startScanProgressTracking();
                } else {
                    hideScanModal();
                    console.error('[SCAN] Failed:', response);
                    showNotification('Error', response.message, 'danger');
                }
            },
            error: function(xhr, status, error) {
                hideScanModal();
                console.error('[SCAN] AJAX Error:', {
                    xhr,
                    status,
                    error
                });
                console.error('[SCAN] Response Text:', xhr.responseText);
                showNotification('Error', 'Failed to start scan: ' + error, 'danger');
            }
        });
    }

    function startScanProgressTracking() {
        console.log('[PROGRESS] Starting scan progress tracking...');

        scanCheckInterval = setInterval(function() {
            $.ajax({
                url: "<?= MDIR ?>get-malware-scan-progress",
                method: "GET",
                dataType: "json",
                success: function(data) {
                    console.log('[PROGRESS]', data);

                    const progress = data.progress || 0;
                    $('#scanPercentage').text(progress + '%');
                    $('#scanStatusText').text(data.status || 'Scanning...');

                    // Update stage indicators
                    updateStageIndicators(data.stage || 'init', progress);

                    if (progress >= 100) {
                        console.log('[COMPLETE] Scan finished');
                        clearInterval(scanCheckInterval);
                        setTimeout(function() {
                            hideScanModal();
                            showNotification('Success', 'Analysis complete!', 'success');
                            updateStatistics();
                            loadReports();
                            loadScanQueue();
                        }, 1500);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('[ERROR] Progress tracking:', error);
                }
            });
        }, 1000);
    }

    function updateStageIndicators(stage, progress) {
        // Reset all stages
        $('.stage-icon').removeClass('active complete');

        if (progress >= 25 || stage === 'static') {
            $('#stage1').addClass('complete');
        }
        if (progress >= 50 || stage === 'detection') {
            $('#stage1').addClass('complete');
            $('#stage2').addClass(progress >= 50 ? 'complete' : 'active');
        }
        if (progress >= 75 || stage === 'behavioral') {
            $('#stage1, #stage2').addClass('complete');
            $('#stage3').addClass(progress >= 75 ? 'complete' : 'active');
        }
        if (progress >= 90 || stage === 'report') {
            $('#stage1, #stage2, #stage3').addClass('complete');
            $('#stage4').addClass('active');
        }
        if (progress >= 100) {
            $('.stage-icon').addClass('complete');
        }
    }

    function cancelScan() {
        if (confirm('Are you sure you want to cancel the scan?')) {
            clearInterval(scanCheckInterval);
            hideScanModal();
            showNotification('Cancelled', 'Scan cancelled by user', 'info');
        }
    }

    function showScanModal() {
        $('#scanModal').modal('show');
        $('#scanPercentage').text('0%');
        $('#scanStatusText').text('Initializing scan...');
        $('.stage-icon').removeClass('active complete');
    }

    function hideScanModal() {
        $('#scanModal').modal('hide');
    }

    // ==================== DATA LOADING ====================

    function updateStatistics() {
        $.ajax({
            url: "<?= MDIR ?>get-malware-stats",
            method: "GET",
            dataType: "json",
            success: function(data) {
                $('#totalScans').text(data.total_scans || 0);
                $('#malwareDetected').text(data.malware_detected || 0);
                $('#cleanFiles').text(data.clean_files || 0);
                $('#suspiciousFiles').text(data.suspicious_files || 0);
            },
            error: function(xhr, status, error) {
                console.error('[ERROR] Failed to load stats:', error);
            }
        });
    }

    function loadScanQueue() {
        $.ajax({
            url: "<?= MDIR ?>get-scan-queue",
            method: "GET",
            dataType: "json",
            success: function(data) {
                displayScanQueue(data);
            },
            error: function(xhr, status, error) {
                console.error('[ERROR] Failed to load queue:', error);
            }
        });
    }

    function displayScanQueue(queue) {
        const container = $('#scanQueue');

        if (!queue || queue.length === 0) {
            container.html(`
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p>No files in queue</p>
                    </div>
                `);
            return;
        }

        container.empty();
        queue.forEach(item => {
            const statusClass = item.status === 'complete' ? 'status-complete' :
                item.status === 'scanning' ? 'status-scanning' : 'status-pending';

            const html = `
                    <div class="queue-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-file-earmark"></i>
                                <strong class="ms-2">${item.filename}</strong>
                                <small class="text-muted ms-2">(${formatFileSize(item.size)})</small>
                            </div>
                            <div>
                                <span class="queue-status ${statusClass}">${item.status.toUpperCase()}</span>
                                ${item.status === 'pending' ? `
                                    <button class="btn btn-sm btn-primary ms-2" onclick="startScan('${escapeHtml(item.id)}')">
                                        <i class="bi bi-play-fill"></i> Scan
                                    </button>
                                ` : ''}
                                ${item.status === 'complete' ? `
                                    <button class="btn btn-sm btn-success ms-2" onclick="viewReport('${escapeHtml(item.id)}')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-danger ms-2" onclick="deleteSample('${escapeHtml(item.id)}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            container.append(html);
        });
    }

    function loadReports() {
        $.ajax({
            url: "<?= MDIR ?>get-all-malware-reports",
            method: "GET",
            dataType: "json",
            success: function(data) {
                displayReports(data);
            },
            error: function(xhr, status, error) {
                console.error('[ERROR] Failed to load reports:', error);
            }
        });
    }

    function displayReports(reports) {
        const container = $('#reportsList');

        if (!reports || reports.length === 0) {
            container.html(`
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-file-earmark-x" style="font-size: 3rem;"></i>
                        <p>No analysis reports available</p>
                    </div>
                `);
            return;
        }

        container.empty();
        reports.forEach(report => {
            const threatClass = report.threat_level === 'MALICIOUS' ? 'threat-high' :
                report.threat_level === 'SUSPICIOUS' ? 'threat-medium' :
                report.threat_level === 'LOW' ? 'threat-low' : 'threat-clean';

            const html = `
                    <div class="card report-card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="mb-1">
                                        <i class="bi bi-file-earmark-code"></i> ${report.filename}
                                    </h5>
                                    <small class="text-muted">Analyzed: ${report.scan_date}</small>
                                </div>
                                <div class="col-md-3 text-center">
                                    <span class="threat-badge ${threatClass}">
                                        ${report.threat_level}
                                    </span>
                                    <div class="mt-2">
                                        <small class="text-muted">Confidence: ${report.ml_confidence}%</small>
                                    </div>
                                </div>
                                <div class="col-md-3 text-end">
                                    <button class="btn btn-sm btn-primary" onclick="viewReport('${escapeHtml(report.file_id)}')">
                                        <i class="bi bi-eye"></i> View Report
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="exportReport('${report.file_id}')">
                                        <i class="bi bi-download"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteSample('${report.file_id}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            container.append(html);
        });
    }

    function viewReport(fileId) {
        console.log('[VIEW] Attempting to view report:', fileId);
        currentReportId = fileId;

        $.ajax({
            url: "<?= MDIR ?>get-malware-report",
            method: "GET",
            data: {
                file_id: fileId
            },
            dataType: "json",
            success: function(response) {
                console.log('[VIEW] Response:', response);
                if (response.success) {
                    displayReportModal(response.report);
                } else {
                    console.error('[VIEW] Failed:', response);
                    showNotification('Error', response.message + ' (Check console)', 'danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('[VIEW] AJAX Error:', {
                    xhr,
                    status,
                    error
                });
                console.error('[VIEW] Response Text:', xhr.responseText);
                showNotification('Error', 'Failed to load report: ' + error, 'danger');
            }
        });
    }

    function displayReportModal(report) {
        $('#reportModalTitle').html(`
                <i class="bi bi-file-earmark-text"></i> Analysis Report - ${report.filename}
            `);

        const threatClass = report.threat_level === 'MALICIOUS' ? 'threat-high' :
            report.threat_level === 'SUSPICIOUS' ? 'threat-medium' :
            report.threat_level === 'LOW' ? 'threat-low' : 'threat-clean';

        const behaviorBadges = (report.behaviors || []).map(b =>
            `<span class="behavior-indicator ${b.severity === 'high' ? 'behavior-malicious' : 'behavior-suspicious'}">
                    ${b.type}
                </span>`
        ).join('');

        const html = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="analysis-detail">
                            <h6 class="gradient-text mb-3">File Information</h6>
                            <div class="detail-row">
                                <span class="detail-label">Filename:</span>
                                <span class="detail-value">${report.filename}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">File Size:</span>
                                <span class="detail-value">${formatFileSize(report.file_size)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">File Type:</span>
                                <span class="detail-value">${report.file_type || 'Unknown'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Scan Date:</span>
                                <span class="detail-value">${report.scan_date}</span>
                            </div>
                        </div>

                        <div class="analysis-detail">
                            <h6 class="gradient-text mb-3">Hash Values</h6>
                            <div class="mb-2">
                                <small class="detail-label">MD5:</small>
                                <div class="hash-display">${report.md5 || 'N/A'}</div>
                            </div>
                            <div class="mb-2">
                                <small class="detail-label">SHA256:</small>
                                <div class="hash-display">${report.sha256 || 'N/A'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="analysis-detail">
                            <h6 class="gradient-text mb-3">Threat Assessment</h6>
                            <div class="text-center mb-3">
                                <span class="threat-badge ${threatClass}" style="font-size: 1.2rem;">
                                    ${report.threat_level}
                                </span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">ML Confidence:</span>
                                <span class="detail-value">${report.ml_confidence}%</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Malware Probability:</span>
                                <span class="detail-value">${report.malware_probability}%</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">VirusTotal Detections:</span>
                                <span class="detail-value">${report.vt_detections || 0} / ${report.vt_total_engines || 70}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Detection Sources:</span>
                                <span class="detail-value">${report.detection_sources || 'None'}</span>
                            </div>
                        </div>

                        <div class="analysis-detail">
                            <h6 class="gradient-text mb-3">Detection Details</h6>
                            <div class="detail-row">
                                <span class="detail-label">Entropy:</span>
                                <span class="detail-value">${report.entropy ? report.entropy.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Packed:</span>
                                <span class="detail-value">${report.is_packed ? 'Yes' : 'No'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Suspicious APIs:</span>
                                <span class="detail-value">${report.suspicious_apis || 0}</span>
                            </div>
                        </div>
                    </div>
                </div>

                ${report.behaviors && report.behaviors.length > 0 ? `
                    <div class="analysis-detail mt-3">
                        <h6 class="gradient-text mb-3">Detected Behaviors</h6>
                        <div class="mb-2">${behaviorBadges}</div>
                        <ul class="list-unstyled mt-3">
                            ${report.behaviors.map(b => `
                                <li class="mb-2">
                                    <i class="bi bi-arrow-right-circle-fill text-${b.severity === 'high' ? 'danger' : 'warning'}"></i>
                                    <strong>${b.type}:</strong> ${b.description}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${report.strings && report.strings.length > 0 ? `
                    <div class="analysis-detail mt-3">
                        <h6 class="gradient-text mb-3">Suspicious Strings (Top 20)</h6>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${report.strings.slice(0, 20).map(s => 
                                `<div class="small text-monospace mb-1">${escapeHtml(s)}</div>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}

                ${report.behavioral_analysis && report.behavioral_analysis.threat_indicators ? `
                    <div class="analysis-detail mt-3">
                        <h6 class="gradient-text mb-3">Threat Intelligence</h6>
                        <div class="detail-row">
                            <span class="detail-label">Threat Score:</span>
                            <span class="detail-value">${report.behavioral_analysis.threat_indicators.threat_score}/100</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Risk Level:</span>
                            <span class="detail-value">${report.behavioral_analysis.threat_indicators.risk_level}</span>
                        </div>
                        ${report.behavioral_analysis.threat_indicators.primary_threats && report.behavioral_analysis.threat_indicators.primary_threats.length > 0 ? `
                            <div class="detail-row">
                                <span class="detail-label">Primary Threats:</span>
                                <span class="detail-value">${report.behavioral_analysis.threat_indicators.primary_threats.join(', ')}</span>
                            </div>
                        ` : ''}
                        ${report.behavioral_analysis.threat_indicators.recommendations && report.behavioral_analysis.threat_indicators.recommendations.length > 0 ? `
                            <div class="mt-3">
                                <strong>Recommendations:</strong>
                                <ul class="mt-2 mb-0">
                                    ${report.behavioral_analysis.threat_indicators.recommendations.map(r => 
                                        `<li>${r}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
            `;

        $('#reportModalBody').html(html);
        $('#reportModal').modal('show');
    }

    // ==================== ACTIONS ====================

    function refreshQueue() {
        loadScanQueue();
        showNotification('Refreshed', 'Queue updated', 'info');
    }

    function deleteSample(fileId) {
        console.log('[DELETE] Attempting to delete file:', fileId);

        if (confirm('Delete this sample and its report?')) {
            $.ajax({
                url: "<?= MDIR ?>delete-malware-sample",
                method: "POST",
                data: {
                    file_id: fileId
                },
                dataType: "json",
                success: function(response) {
                    console.log('[DELETE] Response:', response);
                    if (response.success) {
                        showNotification('Deleted', response.message, 'success');
                        loadScanQueue();
                        loadReports();
                        updateStatistics();
                    } else {
                        console.error('[DELETE] Failed:', response);
                        showNotification('Error', response.message + ' (Check console)', 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('[DELETE] AJAX Error:', {
                        xhr,
                        status,
                        error
                    });
                    console.error('[DELETE] Response Text:', xhr.responseText);
                    showNotification('Error', 'Failed to delete sample: ' + error, 'danger');
                }
            });
        }
    }

    function exportReport(fileId) {
        $.ajax({
            url: "<?= MDIR ?>export-malware-report",
            method: "POST",
            data: $.param({
                file_id: fileId,
                format: 'json'
            }),
            contentType: "application/x-www-form-urlencoded",
            dataType: "json",
            success: function(response) {
                if (response.success) {
                    showNotification('Success', 'Report exported', 'success');
                    window.open(response.download_url, '_blank');
                } else {
                    showNotification('Error', response.message, 'danger');
                }
            },
            error: function(xhr, status, error) {
                showNotification('Error', 'Failed to export report', 'danger');
            }
        });
    }

    function exportCurrentReport() {
        if (currentReportId) {
            exportReport(currentReportId);
        }
    }

    function exportAllReports() {
        showNotification('Info', 'Exporting all reports...', 'info');

        $.ajax({
            url: "<?= MDIR ?>get-all-malware-reports",
            method: "GET",
            dataType: "json",
            success: function(reports) {
                if (reports && reports.length > 0) {
                    const dataStr = JSON.stringify(reports, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

                    const exportFileDefaultName = 'malware_reports_' + Date.now() + '.json';

                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();

                    showNotification('Success', 'All reports exported', 'success');
                } else {
                    showNotification('Error', 'No reports to export', 'warning');
                }
            },
            error: function(xhr, status, error) {
                showNotification('Error', 'Failed to export reports', 'danger');
            }
        });
    }

    // ==================== UTILITIES ====================

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) {
            return map[m];
        });
    }

    function showNotification(title, message, type) {
        const alertClass = type === 'danger' ? 'alert-danger' :
            type === 'success' ? 'alert-success' :
            type === 'warning' ? 'alert-warning' : 'alert-info';

        const icon = type === 'danger' ? 'bi-x-circle-fill' :
            type === 'success' ? 'bi-check-circle-fill' :
            type === 'warning' ? 'bi-exclamation-triangle-fill' : 'bi-info-circle-fill';

        const notification = $(`
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                     style="top: 80px; right: 20px; z-index: 10001; min-width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
                    <i class="bi ${icon}"></i>
                    <strong>${title}:</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);

        $('body').append(notification);

        setTimeout(function() {
            notification.fadeOut(function() {
                $(this).remove();
            });
        }, 5000);
    }

    // Cleanup on page unload
    $(window).on('beforeunload', function() {
        if (scanCheckInterval) {
            clearInterval(scanCheckInterval);
        }
    });
    </script>
</body>

</html>