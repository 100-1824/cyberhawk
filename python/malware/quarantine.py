"""
QuarantineFile Class

Purpose: Manages files isolated due to threats.

This class wraps quarantine functionality for malicious files
"""

import os
import shutil
import json
from datetime import datetime
from pathlib import Path


class QuarantineFile:
    """
    Manages files isolated due to detected threats.

    Attributes:
        filename: Name of quarantined file
        originalLocation: Original file path
        quarantineDate: When file was quarantined
        threatType: Type of threat detected
    """

    def __init__(self, filename, originalLocation, threatType='unknown'):
        """
        Initialize QuarantineFile

        Args:
            filename: Name of the file
            originalLocation: Original path of the file
            threatType: Type of threat detected
        """
        self.filename = filename
        self.originalLocation = originalLocation
        self.quarantineDate = datetime.now().isoformat()
        self.threatType = threatType
        self.quarantinePath = None
        self.fileHash = None
        self.fileSize = 0

    def quarantine(self, quarantine_dir=None):
        """
        Move file to quarantine directory

        Args:
            quarantine_dir: Directory for quarantined files

        Returns:
            dict: Status dictionary
        """
        if quarantine_dir is None:
            current_dir = Path(__file__).resolve().parent
            project_root = current_dir.parent.parent
            quarantine_dir = project_root / "assets" / "data" / "quarantine"

        quarantine_dir = Path(quarantine_dir)
        quarantine_dir.mkdir(parents=True, exist_ok=True)

        try:
            # Generate safe filename
            safe_filename = f"quarantine_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{self.filename}"
            self.quarantinePath = quarantine_dir / safe_filename

            # Move file to quarantine
            if os.path.exists(self.originalLocation):
                shutil.move(self.originalLocation, self.quarantinePath)
                self.fileSize = os.path.getsize(self.quarantinePath)

                # Save quarantine record
                self._saveQuarantineRecord()

                return {
                    'success': True,
                    'message': 'File quarantined successfully',
                    'quarantine_path': str(self.quarantinePath)
                }
            else:
                return {
                    'success': False,
                    'message': 'Original file not found'
                }

        except Exception as e:
            return {
                'success': False,
                'message': f'Failed to quarantine file: {str(e)}'
            }

    def restore(self):
        """
        Restores file to original location.

        Returns:
            dict: Status dictionary
        """
        try:
            if not self.quarantinePath or not os.path.exists(self.quarantinePath):
                return {
                    'success': False,
                    'message': 'Quarantined file not found'
                }

            # Check if original location exists
            original_dir = os.path.dirname(self.originalLocation)
            if not os.path.exists(original_dir):
                os.makedirs(original_dir, exist_ok=True)

            # Restore file
            shutil.move(self.quarantinePath, self.originalLocation)

            # Remove quarantine record
            self._removeQuarantineRecord()

            return {
                'success': True,
                'message': 'File restored successfully'
            }

        except Exception as e:
            return {
                'success': False,
                'message': f'Failed to restore file: {str(e)}'
            }

    def delete(self):
        """
        Permanently deletes the file.

        Returns:
            dict: Status dictionary
        """
        try:
            if self.quarantinePath and os.path.exists(self.quarantinePath):
                os.remove(self.quarantinePath)

                # Remove quarantine record
                self._removeQuarantineRecord()

                return {
                    'success': True,
                    'message': 'File deleted permanently'
                }
            else:
                return {
                    'success': False,
                    'message': 'Quarantined file not found'
                }

        except Exception as e:
            return {
                'success': False,
                'message': f'Failed to delete file: {str(e)}'
            }

    def _saveQuarantineRecord(self):
        """Save quarantine record to JSON file"""
        current_dir = Path(__file__).resolve().parent
        project_root = current_dir.parent.parent
        quarantine_file = project_root / "assets" / "data" / "qurantine.json"

        records = []
        if quarantine_file.exists():
            with open(quarantine_file, 'r') as f:
                records = json.load(f) if f.read().strip() else []
                f.seek(0)

        records.append({
            'filename': self.filename,
            'original_location': self.originalLocation,
            'quarantine_path': str(self.quarantinePath),
            'quarantine_date': self.quarantineDate,
            'threat_type': self.threatType,
            'file_size': self.fileSize
        })

        with open(quarantine_file, 'w') as f:
            json.dump(records, f, indent=4)

    def _removeQuarantineRecord(self):
        """Remove quarantine record from JSON file"""
        current_dir = Path(__file__).resolve().parent
        project_root = current_dir.parent.parent
        quarantine_file = project_root / "assets" / "data" / "qurantine.json"

        if not quarantine_file.exists():
            return

        with open(quarantine_file, 'r') as f:
            records = json.load(f)

        # Remove this file's record
        records = [r for r in records if r.get('filename') != self.filename]

        with open(quarantine_file, 'w') as f:
            json.dump(records, f, indent=4)

    def to_dict(self):
        """Convert to dictionary"""
        return {
            'filename': self.filename,
            'original_location': self.originalLocation,
            'quarantine_path': str(self.quarantinePath) if self.quarantinePath else None,
            'quarantine_date': self.quarantineDate,
            'threat_type': self.threatType,
            'file_size': self.fileSize
        }

    @staticmethod
    def getAllQuarantinedFiles():
        """
        Get all quarantined files

        Returns:
            list: List of quarantined file records
        """
        current_dir = Path(__file__).resolve().parent
        project_root = current_dir.parent.parent
        quarantine_file = project_root / "assets" / "data" / "qurantine.json"

        if not quarantine_file.exists():
            return []

        try:
            with open(quarantine_file, 'r') as f:
                return json.load(f)
        except:
            return []
