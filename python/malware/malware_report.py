"""
MalwareReport Class

Purpose: Contains detailed results from malware scanning.

This class represents malware scan reports with threat analysis
"""

import json
from datetime import datetime
from pathlib import Path


class MalwareReport:
    """
    Contains detailed results from malware scanning operations.

    Attributes:
        file_id: Unique file identifier
        filename: Name of the scanned file
        threat_level: Assessed threat level (safe, low, medium, high, critical)
        vt_detections: Number of VirusTotal detections
        detection_sources: Sources that detected threats
    """

    def __init__(self, file_id, filename):
        """
        Initialize MalwareReport

        Args:
            file_id: Unique identifier for the scanned file
            filename: Name of the file
        """
        self.file_id = file_id
        self.filename = filename
        self.threat_level = 'unknown'
        self.vt_detections = 0
        self.detection_sources = []
        self.scan_timestamp = datetime.now().isoformat()
        self.file_hash = None
        self.file_size = 0
        self.scan_results = {}
        self.behavioral_analysis = {}
        self.static_analysis = {}

    def generateReport(self):
        """
        Creates formatted report.

        Generates a comprehensive report dictionary with all scan results,
        threat assessments, and detection information.

        Returns:
            dict: Formatted report data
        """
        report = {
            'file_id': self.file_id,
            'filename': self.filename,
            'threat_level': self.threat_level,
            'scan_timestamp': self.scan_timestamp,
            'file_hash': self.file_hash,
            'file_size': self.file_size,
            'virus_total': {
                'detections': self.vt_detections,
                'detection_sources': self.detection_sources
            },
            'scan_results': self.scan_results,
            'behavioral_analysis': self.behavioral_analysis,
            'static_analysis': self.static_analysis,
            'recommendation': self._getRecommendation()
        }

        return report

    def _getRecommendation(self):
        """Get security recommendation based on threat level"""
        recommendations = {
            'safe': 'File appears to be safe. No threats detected.',
            'low': 'Low risk detected. Monitor file activity.',
            'medium': 'Medium threat detected. Consider quarantine.',
            'high': 'High threat detected. Quarantine recommended.',
            'critical': 'Critical threat detected! Immediate quarantine required.',
            'unknown': 'Unable to determine threat level.'
        }
        return recommendations.get(self.threat_level, 'No recommendation available.')

    def setVirusTotalResults(self, vt_data):
        """
        Set VirusTotal scan results

        Args:
            vt_data: VirusTotal API response data
        """
        if vt_data and 'data' in vt_data:
            attributes = vt_data['data'].get('attributes', {})
            stats = attributes.get('last_analysis_stats', {})

            self.vt_detections = stats.get('malicious', 0)
            self.scan_results['virustotal'] = {
                'malicious': stats.get('malicious', 0),
                'suspicious': stats.get('suspicious', 0),
                'undetected': stats.get('undetected', 0),
                'harmless': stats.get('harmless', 0)
            }

            # Extract detection sources
            results = attributes.get('last_analysis_results', {})
            self.detection_sources = [
                engine for engine, result in results.items()
                if result.get('category') in ['malicious', 'suspicious']
            ]

    def setBehavioralAnalysis(self, behavioral_data):
        """
        Set behavioral analysis results

        Args:
            behavioral_data: Dictionary of behavioral analysis results
        """
        self.behavioral_analysis = behavioral_data

    def setStaticAnalysis(self, static_data):
        """
        Set static analysis results

        Args:
            static_data: Dictionary of static analysis results
        """
        self.static_analysis = static_data

    def assessThreatLevel(self):
        """
        Assess overall threat level based on all scan results

        Returns:
            str: Threat level (safe, low, medium, high, critical)
        """
        # Calculate threat score
        threat_score = 0

        # VirusTotal detections
        if self.vt_detections > 30:
            threat_score += 50
        elif self.vt_detections > 10:
            threat_score += 30
        elif self.vt_detections > 0:
            threat_score += 10

        # Behavioral indicators
        behavioral_indicators = self.behavioral_analysis.get('suspicious_behaviors', [])
        threat_score += len(behavioral_indicators) * 5

        # Static analysis
        if self.static_analysis.get('packed', False):
            threat_score += 15
        if self.static_analysis.get('suspicious_imports', []):
            threat_score += 10

        # Determine threat level
        if threat_score >= 70:
            self.threat_level = 'critical'
        elif threat_score >= 50:
            self.threat_level = 'high'
        elif threat_score >= 30:
            self.threat_level = 'medium'
        elif threat_score >= 10:
            self.threat_level = 'low'
        else:
            self.threat_level = 'safe'

        return self.threat_level

    def saveToFile(self, output_dir=None):
        """
        Save report to JSON file

        Args:
            output_dir: Directory to save report (default: assets/data/malware_reports)

        Returns:
            dict: Status with file path
        """
        if output_dir is None:
            current_dir = Path(__file__).resolve().parent
            project_root = current_dir.parent.parent
            output_dir = project_root / "assets" / "data" / "malware_reports"

        output_dir = Path(output_dir)
        output_dir.mkdir(parents=True, exist_ok=True)

        report_file = output_dir / f"report_{self.file_id}.json"

        try:
            report_data = self.generateReport()
            with open(report_file, 'w') as f:
                json.dump(report_data, f, indent=4)

            return {
                'success': True,
                'path': str(report_file)
            }

        except Exception as e:
            return {
                'success': False,
                'error': str(e)
            }

    def to_dict(self):
        """Convert report to dictionary"""
        return self.generateReport()

    @staticmethod
    def loadFromFile(file_id, reports_dir=None):
        """
        Load report from JSON file

        Args:
            file_id: File identifier
            reports_dir: Directory containing reports

        Returns:
            MalwareReport: Loaded report object or None
        """
        if reports_dir is None:
            current_dir = Path(__file__).resolve().parent
            project_root = current_dir.parent.parent
            reports_dir = project_root / "assets" / "data" / "malware_reports"

        report_file = Path(reports_dir) / f"report_{file_id}.json"

        if not report_file.exists():
            return None

        try:
            with open(report_file, 'r') as f:
                data = json.load(f)

            report = MalwareReport(data['file_id'], data['filename'])
            report.threat_level = data.get('threat_level', 'unknown')
            report.vt_detections = data.get('virus_total', {}).get('detections', 0)
            report.detection_sources = data.get('virus_total', {}).get('detection_sources', [])
            report.scan_timestamp = data.get('scan_timestamp')
            report.file_hash = data.get('file_hash')
            report.file_size = data.get('file_size', 0)
            report.scan_results = data.get('scan_results', {})
            report.behavioral_analysis = data.get('behavioral_analysis', {})
            report.static_analysis = data.get('static_analysis', {})

            return report

        except Exception as e:
            print(f"Error loading report: {str(e)}")
            return None
